<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浪LIVE直播學院 FAQ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'neutral' });</script>

    <style>
        :root {
            --primary-color: #f3357b; 
            --secondary-color: #5d34af;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* 門衛畫面 */
        #entrance-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* 登出按鈕 */
        #logout-btn {
            position: fixed; bottom: 20px; right: 20px; padding: 10px 18px;
            background-color: #666; color: white; border: none; border-radius: 25px;
            cursor: pointer; z-index: 100; opacity: 0.8; transition: 0.3s;
        }
        #logout-btn:hover { opacity: 1; background-color: var(--primary-color); }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 50px 20px; text-align: center;
        }

        .container { max-width: 900px; margin: -30px auto 50px auto; padding: 0 15px; }

        .search-bar {
            width: 100%; padding: 15px 25px; font-size: 18px; border: none;
            border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            outline: none; margin-bottom: 30px; box-sizing: border-box;
        }

        .category-title {
            margin: 40px 0 15px; padding-left: 10px;
            border-left: 5px solid var(--primary-color);
            color: var(--secondary-color); font-size: 1.5rem;
        }

        .faq-item {
            background: white; margin-bottom: 12px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden;
        }

        .faq-question {
            width: 100%; padding: 22px; background: none; border: none;
            text-align: left; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; color: #2c3e50;
        }

        .faq-question::after { content: '+'; font-size: 1.5rem; color: var(--primary-color); transition: 0.3s; }
        .faq-question.active::after { transform: rotate(45deg); }

        .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fff; }
        .answer-inner { padding: 0 25px 25px; border-top: 1px solid #f1f1f1; white-space: pre-wrap; line-height: 1.8; color: #444; }

        .highlight-title { color: #000; font-weight: 800; display: inline-block; margin-top: 10px; }
        .media-container { margin-top: 20px; padding: 15px; background: #fafafa; border: 1px dashed #ddd; border-radius: 8px; text-align: center; }
        .video-box { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 10px; }
        .video-box iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="entrance-gate">
        <h2 style="color: #5d34af;">浪LIVE直播學院 - 登入</h2>
        <p>請輸入您的浪ID或 Email：</p>
        <input type="text" id="user-id-input" placeholder="Email 或 ID" style="padding: 10px; border: 2px solid #f3357b; border-radius: 8px; outline: none; width: 250px; text-align: center;">
        <button onclick="checkAccess()" style="margin-top: 15px; padding: 10px 20px; background: #f3357b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">進入網頁</button>
        <p id="error-msg" style="color: red; display: none; margin-top: 10px;"></p>
    </div>

    <button id="logout-btn" onclick="logout()" style="display: none;">登出系統</button>

    <div class="header">
        <h1>浪LIVE直播學院 FAQ</h1>
        <p>經常被提出的問題大彙整！</p>
    </div>

    <div class="container">
        <input type="text" id="searchInput" class="search-bar" placeholder="搜尋問題或關鍵字..." onkeyup="filterFAQ()">

        <div id="faqList">
            <h2 class="category-title">1. 觀眾互動與新人留存</h2>
            
            <div class="faq-item">
                <button class="faq-question">如何留住路人/新客/大戶？</button>
                <div class="faq-answer">
                    <div class="answer-inner">
                        <span class="highlight-title">吸引目光</span>： 30秒-1分鐘內，創造特色...
                        </div>
                </div>
            </div>
            
            </div>
    </div>

    <script>
        const TIMEOUT_MS = 15 * 60 * 1000; // 15 分鐘
        let logoutTimer;

        // 核心：CSV 網址（已修正換行問題）
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSna5sPtfm_TSZ694NSiWzd09aNnAHz0KdZVJF5PMrC9uPN_twOuS9ITGvhurosNwhaL0_iDRlrji8t/pub?gid=769889894&single=true&output=csv";

        // 1. 驗證登入
        async function checkAccess() {
            const inputVal = document.getElementById('user-id-input').value.trim().toLowerCase();
            const errorMsg = document.getElementById('error-msg');
            const loginBtn = document.querySelector('#entrance-gate button');

            if (!inputVal) return;

            try {
                loginBtn.innerText = "驗證中...";
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).map(row => row.split(','));

                const isAuthorized = rows.some(columns => {
                    const emailInSheet = columns[1]?.trim().toLowerCase();
                    const idInSheet = columns[2]?.trim().toLowerCase();
                    return inputVal === emailInSheet || inputVal === idInSheet;
                });

                if (isAuthorized) {
                    sessionStorage.setItem('isAuthorized', 'true');
                    showContent();
                } else {
                    errorMsg.style.display = 'block';
                    errorMsg.innerText = "找不到匹配的 Email 或 ID。";
                    loginBtn.innerText = "進入網頁";
                }
            } catch (error) {
                console.error("驗證出錯:", error);
                alert("驗證系統連線失敗，請檢查網址或發佈設定。");
                loginBtn.innerText = "進入網頁";
            }
        }

        // 2. 顯示內容與啟動計時
        function showContent() {
            document.getElementById('entrance-gate').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'block';
            resetTimer();
            setupActivityListeners();
        }

        // 3. 登出
        function logout() {
            sessionStorage.clear();
            clearTimeout(logoutTimer);
            window.location.reload();
        }

        // 4. 計時邏輯 (有動作就重計)
        function resetTimer() {
            if (sessionStorage.getItem('isAuthorized') === 'true') {
                sessionStorage.setItem('loginTimestamp', Date.now().toString());
                clearTimeout(logoutTimer);
                logoutTimer = setTimeout(logout, TIMEOUT_MS);
            }
        }

        function setupActivityListeners() {
            const events = ['mousedown', 'keypress', 'scroll', 'touchstart'];
            events.forEach(name => {
                document.addEventListener(name, throttle(resetTimer, 2000));
            });
        }

        function throttle(func, delay) {
            let lastTime = 0;
            return function() {
                const now = Date.now();
                if (now - lastTime >= delay) {
                    func();
                    lastTime = now;
                }
            }
        }

        // 5. 初始狀態檢查
        window.onload = function() {
            const isAuthorized = sessionStorage.getItem('isAuthorized');
            const loginTimestamp = sessionStorage.getItem('loginTimestamp');

            if (isAuthorized === 'true' && loginTimestamp) {
                const now = Date.now();
                if (now - parseInt(loginTimestamp) > TIMEOUT_MS) {
                    logout();
                } else {
                    showContent();
                    // 補回剩下的時間倒數
                    const remaining = TIMEOUT_MS - (now - parseInt(loginTimestamp));
                    logoutTimer = setTimeout(logout, remaining);
                }
            }
            
            // 重新初始化摺疊功能
            initAccordion();
        };

        // --- UI 功能 ---
        function initAccordion() {
            const acc = document.getElementsByClassName("faq-question");
            for (let i = 0; i < acc.length; i++) {
                acc[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    const panel = this.nextElementSibling;
                    panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
                });
            }
        }

        function filterFAQ() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const items = document.getElementsByClassName('faq-item');
            for (let item of items) {
                item.style.display = item.innerText.toLowerCase().includes(input) ? "" : "none";
            }
        }
    </script>
</body>
</html>
